<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>中国語 一文ずつビュー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 16px;
      background: #f9fafb;
      color: #111827;
    }
    h1 { font-size: 18px; margin-bottom: 8px; }
    textarea {
      width: 100%;
      min-height: 120px;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      resize: vertical;
    }
    button {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background: white;
      cursor: pointer;
    }
    button:hover { background: #f3f4f6; }
    button:disabled { opacity: 0.5; cursor: default; }
    .button-row { display: flex; gap: 8px; margin: 8px 0; }

    .sentence-box {
      padding: 12px;
      border-radius: 6px;
      background: white;
      border: 1px solid #e5e7eb;
      margin-top: 12px;
    }
    .label { font-size: 12px; color: #6b7280; margin-bottom: 2px; }
    .chinese { font-size: 20px; margin-bottom: 4px; }
    .pinyin  { font-size: 14px; color: #374151; margin-bottom: 4px; }
    .jp      { font-size: 14px; }

    .nav-row {
      display: flex; gap: 8px; align-items: center;
      margin-top: 8px; font-size: 12px; color: #6b7280;
    }

    .word-cards {
      display: flex; flex-wrap: wrap;
      gap: 8px; margin-top: 12px;
    }
    .word-card {
      border: 1px solid #e5e7eb;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 12px;
      min-width: 80px;
      background: white;
    }
    .word-card .hanzi { font-size: 14px; }
    .word-card .pinyin { color: #374151; }
    .word-card .mean { color: #4b5563; }
  </style>

  <!-- pinyin-pro -->
  <script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.19.3/dist/pinyin-pro.min.js"></script>

  <!-- segmentit（読めなかった場合はフォールバック） -->
  <script src="https://cdn.jsdelivr.net/npm/segmentit@1.0.3/dist/segmentit.min.js"></script>
</head>

<body>
  <h1>中国語 一文ずつビュー</h1>

  <textarea id="sourceInput" placeholder="ここに中国語を貼り付けてください"></textarea>

  <div class="button-row">
    <button id="pasteBtn">ペースト</button>
    <button id="clearBtn">全消し</button>
    <button id="translateBtn" style="background:#22c55e; color:white;">翻訳する</button>
  </div>

  <div id="viewer" class="sentence-box" style="display:none;">
    <div class="label">中国語</div>
    <div id="cnSentence" class="chinese"></div>

    <div class="label">ピンイン</div>
    <div id="pinyinSentence" class="pinyin"></div>

    <div class="label">日本語訳</div>
    <div id="jpSentence" class="jp"></div>

    <div class="nav-row">
      <button id="prevBtn">◀</button>
      <button id="nextBtn">▶</button>
      <span id="counter"></span>
      <span id="status"></span>
    </div>

    <div class="label" style="margin-top:10px;">単語カード</div>
    <div id="wordCards" class="word-cards"></div>
  </div>

<script>
  // segmentit が読み込めた場合のみ使う
  let segmenter = null;
  if (window.segmentit && typeof window.segmentit.useDefault === "function") {
    segmenter = window.segmentit.useDefault();
  }

  const sourceInput   = document.getElementById("sourceInput");
  const pasteBtn      = document.getElementById("pasteBtn");
  const clearBtn      = document.getElementById("clearBtn");
  const translateBtn  = document.getElementById("translateBtn");

  const viewer        = document.getElementById("viewer");
  const cnSentenceEl  = document.getElementById("cnSentence");
  const pinyinSentenceEl = document.getElementById("pinyinSentence");
  const jpSentenceEl  = document.getElementById("jpSentence");
  const wordCardsEl   = document.getElementById("wordCards");
  const statusEl      = document.getElementById("status");

  const prevBtn       = document.getElementById("prevBtn");
  const nextBtn       = document.getElementById("nextBtn");
  const counterEl     = document.getElementById("counter");

  let sentences = [];
  let index = 0;
  let loading = false;

  function splitSentences(text) {
    if (!text) return [];
    return text
      .replace(/\r\n/g,"\n")
      .replace(/\s+/g,"")
      .split(/(?<=[。！？!?])/)
      .map(s => s.trim())
      .filter(Boolean);
  }

  async function translate(text) {
    const url =
      "https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh&tl=ja&dt=t&q=" +
      encodeURIComponent(text);
    const res = await fetch(url);
    const data = await res.json();
    return data[0].map(x => x[0]).join("");
  }

  async function buildWordCards(sentence) {
    let words = [];

    if (segmenter) {
      // segmentit が使える場合
      const segs = segmenter.doSegment(sentence, { simple: true });
      words = [...new Set(segs.filter(w => /[\u4e00-\u9fff]/.test(w)))];
    } else {
      // フォールバック：漢字を1文字ずつユニークに
      const blocks = sentence.match(/[\u4e00-\u9fff]+/g) || [];
      const set = new Set();
      blocks.forEach(b => { for (const ch of b) set.add(ch); });
      words = [...set];
    }

    const cards = [];
    for (let w of words) {
      const pinyin = window.pinyinPro.pinyin(w, { toneType:"pinyin", type:"string" });
      let jp;
      try { jp = await translate(w); }
      catch { jp = "(翻訳エラー)"; }
      cards.push({ w, pinyin, jp });
    }
    return cards;
  }

  async function show(idx) {
    index = idx;
    const s = sentences[index];

    cnSentenceEl.textContent = s;
    pinyinSentenceEl.textContent = "";
    jpSentenceEl.textContent = "";
    counterEl.textContent = `${index+1} / ${sentences.length}`;
    wordCardsEl.innerHTML = "";

    loading = true;
    statusEl.textContent = "読み込み中…";

    try {
      const py = window.pinyinPro.pinyin(s, { toneType:"pinyin", type:"string", nonZh:"consecutive" });
      const jp = await translate(s);
      const cards = await buildWordCards(s);

      pinyinSentenceEl.textContent = py;
      jpSentenceEl.textContent = jp;

      cards.forEach(c => {
        wordCardsEl.innerHTML += `
          <div class="word-card">
            <div class="hanzi">${c.w}</div>
            <div class="pinyin">${c.pinyin}</div>
            <div class="mean">${c.jp}</div>
          </div>`;
      });
    } finally {
      statusEl.textContent = "";
      loading = false;
    }
  }

  // ペースト：貼るだけ（ローカル file:// だとブラウザ設定で使えないことがあります）
  pasteBtn.onclick = async () => {
    try {
      const text = await navigator.clipboard.readText();
      if (!text) {
        alert("クリップボードにテキストがありません。");
        return;
      }
      sourceInput.value = text;
    } catch (e) {
      alert("クリップボードから読み取れませんでした：" + e.message);
    }
  };

  clearBtn.onclick = () => {
    sourceInput.value = "";
    viewer.style.display = "none";
  };

  translateBtn.onclick = () => {
    sentences = splitSentences(sourceInput.value);
    if (sentences.length === 0) {
      alert("文章がありません");
      return;
    }
    viewer.style.display = "block";
    show(0);
  };

  prevBtn.onclick = () => { if (!loading && index > 0) show(index - 1); };
  nextBtn.onclick = () => { if (!loading && index < sentences.length - 1) show(index + 1); };
</script>
</body>
</html>
