<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>中国語 一文ずつビュー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      background: #f3f4f6;
      color: #111827;
    }

    .app {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 16px;
    }

    .app-inner {
      width: 100%;
      max-width: 960px;
    }

    h1 {
      font-size: 22px;
      margin-bottom: 14px;
    }

    textarea {
      width: 100%;
      min-height: 140px;
      padding: 10px;
      font-size: 15px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      resize: vertical;
      background: white;
    }

    button {
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      cursor: pointer;
    }

    button:hover { background: #f3f4f6; }
    button:disabled { opacity: 0.5; cursor: default; }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0 14px;
    }

    /* 解析結果パネル */
    .sentence-box {
      padding: 14px;
      border-radius: 10px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      margin-top: 6px;
    }

    .label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .chinese {
      font-size: 22px;
      margin-bottom: 6px;
      word-wrap: break-word;
    }
    .pinyin { font-size: 15px; margin-bottom: 6px; }
    .jp { font-size: 15px; margin-bottom: 6px; }

    .nav-row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-top: 10px;
      font-size: 13px;
    }

    /* 単語カード */
    .word-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 14px;
    }

    .word-card {
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 14px;
      min-width: 100px;
      background: #ffffff;
    }

    .word-card .hanzi { font-size: 17px; margin-bottom: 4px; }
    .word-card .pinyin { font-size: 13px; margin-bottom: 3px; }
    .word-card .mean { font-size: 13px; }

    /* 単語登録フォーム */
    .dict-section {
      margin-top: 26px;
      padding: 16px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .dict-title {
      font-size: 18px;
      margin-bottom: 12px;
      font-weight: bold;
    }

    .dict-form {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .dict-form input {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      background: #f9fafb;
    }

    .dict-word   { width: 160px; }
    .dict-pinyin { width: 200px; }
    .dict-ja     { flex: 1; min-width: 180px; }

    #dictAddBtn {
      padding: 10px 14px;
      font-size: 14px;
      background: #22c55e;
      border-color:#16a34a;
      color: white;
      font-weight: bold;
      border-radius: 8px;
    }

    #dictStatus {
      margin-top: 8px;
      font-size: 13px;
      color: #374151;
    }

    @media (max-width: 480px) {

      textarea { font-size: 14px; }

      .dict-form { flex-direction: column; align-items: stretch; }
      .dict-form input { width: 100%; }

      .word-card { flex: 1 1 calc(50% - 10px); }

      .chinese { font-size: 19px; }
    }
  </style>

  <!-- pinyin-pro -->
  <script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.27.0/dist/index.min.js"></script>

  <!-- segmentit UMD -->
  <script src="https://cdn.jsdelivr.net/npm/segmentit@2.0.3/dist/umd/segmentit.min.js"></script>
</head>

<body>
<div class="app">
  <div class="app-inner">

    <h1>中国語 一文ずつビュー</h1>

    <textarea id="sourceInput" placeholder="ここに中国語を貼り付けてください"></textarea>

    <div class="button-row">
      <button id="pasteBtn">ペースト</button>
      <button id="clearBtn">全消し</button>
      <button id="translateBtn" style="background:#22c55e; color:white;">翻訳する</button>
    </div>

    <!-- 解析結果 -->
    <div id="viewer" class="sentence-box" style="display:none;">
      <div class="label">中国語</div>
      <div id="cnSentence" class="chinese"></div>

      <div class="label">ピンイン</div>
      <div id="pinyinSentence" class="pinyin"></div>

      <div class="label">日本語訳</div>
      <div id="jpSentence" class="jp"></div>

      <div class="nav-row">
        <button id="prevBtn">◀</button>
        <button id="nextBtn">▶</button>
        <span id="counter"></span>
        <span id="status"></span>
      </div>

      <div class="label" style="margin-top:12px;">単語カード</div>
      <div id="wordCards" class="word-cards"></div>

      <div id="segStatus" class="label" style="margin-top:14px;"></div>
    </div>

    <!-- ▼ 単語登録フォーム（常に表示） -->
    <div class="dict-section">
      <div class="dict-title">単語登録</div>

      <div class="dict-form">
        <input id="dictWord"   class="dict-word"   placeholder="漢字 例：萨菲罗斯">
        <input id="dictPinyin" class="dict-pinyin" placeholder="ピンイン 例：sà fēi luó sī">
        <input id="dictJa"     class="dict-ja"     placeholder="日本語訳 例：セフィロス">
        <button id="dictAddBtn">登録</button>
      </div>

      <div id="dictStatus"></div>
    </div>

  </div>
</div>

<script>
/* -------------- 設定 -------------- */
const STORAGE_KEY = "customCnDict";

// ベース辞書
const BASE_DICT = {
  "克劳德": { pinyin: "kè láo dé", ja: "クラウド" },
  "萨菲罗斯": { pinyin: "sà fēi luó sī", ja: "セフィロス" },
  "宝条": { pinyin: "bǎo tiáo", ja: "宝条" },
  "艾瑞丝": { pinyin: "ài ruì sī", ja: "エアリス" },
  "蒂法": { pinyin: "dì fǎ", ja: "ティファ" }
};

/* -------------- 辞書ロードと反映 -------------- */
function loadUserDict() {
  try {
    const data = localStorage.getItem(STORAGE_KEY);
    return data ? JSON.parse(data) : {};
  } catch { return {}; }
}

let USER_DICT = loadUserDict();
const CUSTOM_DICT = { ...BASE_DICT, ...USER_DICT };

/* -------------- 解析ロジック -------------- */

const hasPinyinPro = !!(window.pinyinPro && typeof window.pinyinPro.pinyin === "function");

let segmenter = null;
if (window.Segmentit && window.Segmentit.Segment) {
  segmenter = window.Segmentit.useDefault(new window.Segmentit.Segment());
}

/* ---- DOM ---- */
const sourceInput = document.getElementById("sourceInput");
const pasteBtn = document.getElementById("pasteBtn");
const clearBtn = document.getElementById("clearBtn");
const translateBtn = document.getElementById("translateBtn");

const viewer = document.getElementById("viewer");
const cnSentenceEl = document.getElementById("cnSentence");
const pinyinSentenceEl = document.getElementById("pinyinSentence");
const jpSentenceEl = document.getElementById("jpSentence");
const wordCardsEl = document.getElementById("wordCards");
const statusEl = document.getElementById("status");
const segStatusEl = document.getElementById("segStatus");

const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const counterEl = document.getElementById("counter");

/* ---- 単語登録フォーム ---- */
const dictWordEl = document.getElementById("dictWord");
const dictPinyinEl = document.getElementById("dictPinyin");
const dictJaEl = document.getElementById("dictJa");
const dictAddBtn = document.getElementById("dictAddBtn");
const dictStatusEl = document.getElementById("dictStatus");

/* ---- 文の配列 ---- */
let sentences = [];
let index = 0;
let loading = false;

segStatusEl.textContent = segmenter
  ? "単語分割: segmentit を使用中（単語ごとにカード）"
  : "単語分割: segmentit が読み込めていないため漢字1文字ごと";

/* ---- 文分割 ---- */
function splitSentences(text) {
  return text
    .replace(/\r\n/g, "\n")
    .replace(/\s+/g, "")
    .split(/(?<=[。！？!?])/)
    .map(s => s.trim())
    .filter(Boolean);
}

/* ---- Google 翻訳 ---- */
async function translate(text) {
  const url =
    "https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh&tl=ja&dt=t&q=" +
    encodeURIComponent(text);
  const res = await fetch(url);
  const data = await res.json();
  return data[0].map(x => x[0]).join("");
}

function hasCJK(str) {
  return /[\u3400-\u9FFF]/.test(str);
}

/* ---- 固有名詞マージ ---- */
function mergeNamesByRange(text, tokens, positions) {
  const ranges = [];
  const names = Object.keys(CUSTOM_DICT);

  for (const name of names) {
    let idx = text.indexOf(name);
    while (idx !== -1) {
      ranges.push({ name, start: idx, end: idx + name.length });
      idx = text.indexOf(name, idx + 1);
    }
  }
  if (!ranges.length) return { tokens, positions };

  ranges.sort((a,b) => a.start - b.start);

  const mergedTokens = [];
  const mergedPositions = [];
  let r = 0;
  let range = ranges[r];

  for (let i=0; i<tokens.length; i++) {
    const pos = positions[i];

    while (range && pos.start >= range.end) {
      range = ranges[++r];
    }
    if (
      range &&
      pos.start >= range.start &&
      pos.end <= range.end
    ) {
      if (!mergedTokens.length || mergedTokens.at(-1) !== range.name) {
        mergedTokens.push(range.name);
        mergedPositions.push({ start: range.start, end: range.end });
      }
      while (i+1 < tokens.length && positions[i+1].end <= range.end) {
        i++;
      }
    } else {
      mergedTokens.push(tokens[i]);
      mergedPositions.push(pos);
    }
  }
  return { tokens: mergedTokens, positions: mergedPositions };
}

/* ---- 単語カード生成 ---- */
async function buildWordCards(sentence) {
  let words = [];

  if (segmenter) {
    const segObjs = segmenter.doSegment(sentence);
    const rawTokens = [];
    const rawPositions = [];
    let cursor = 0;

    for (const s of segObjs) {
      const w = s.w || "";
      if (!w) continue;
      const idx = sentence.indexOf(w, cursor);
      if (idx === -1) continue;
      const start = idx;
      const end = idx + w.length;
      cursor = end;
      if (/^\s+$/.test(w)) continue;
      rawTokens.push(w);
      rawPositions.push({ start, end });
    }

    const merged = mergeNamesByRange(sentence, rawTokens, rawPositions);
    const tokens = merged.tokens;

    words = [...new Set(tokens.filter(hasCJK))];
  } else {
    const blocks = sentence.match(/[\u4e00-\u9fff]+/g) || [];
    const set = new Set();
    blocks.forEach(b => { for (const ch of b) set.add(ch); });
    words = [...set];
  }

  const cards = [];
  for (let w of words) {
    let py, jp;

    if (CUSTOM_DICT[w]) {
      py = CUSTOM_DICT[w].pinyin;
      jp = CUSTOM_DICT[w].ja;
    } else {
      py = hasPinyinPro
        ? window.pinyinPro.pinyin(w, { toneType: "pinyin", type: "string" })
        : "-";
      try { jp = await translate(w); }
      catch { jp = "(翻訳エラー)"; }
    }
    cards.push({ w, pinyin: py, jp });
  }
  return cards;
}

/* ---- 文の表示 ---- */
async function show(idx) {
  index = idx;
  const s = sentences[index];

  cnSentenceEl.textContent = s;
  pinyinSentenceEl.textContent = "";
  jpSentenceEl.textContent = "";
  wordCardsEl.innerHTML = "";
  counterEl.textContent = `${index + 1} / ${sentences.length}`;

  loading = true;
  statusEl.textContent = "読み込み中…";

  try {
    const py = hasPinyinPro
      ? window.pinyinPro.pinyin(s, {
          toneType: "pinyin",
          type: "string",
          nonZh: "consecutive"
        })
      : "(pinyin-pro が読み込めていません)";

    const jp = await translate(s);
    const cards = await buildWordCards(s);

    pinyinSentenceEl.textContent = py;
    jpSentenceEl.textContent = jp;

    cards.forEach(c => {
      wordCardsEl.innerHTML += `
        <div class="word-card">
          <div class="hanzi">${c.w}</div>
          <div class="pinyin">${c.pinyin}</div>
          <div class="mean">${c.jp}</div>
        </div>`;
    });

  } finally {
    statusEl.textContent = "";
    loading = false;
  }
}

/* ---- 単語登録：SAVE & 即反映 ---- */
dictAddBtn.onclick = () => {
  const w = dictWordEl.value.trim();
  const p = dictPinyinEl.value.trim();
  const j = dictJaEl.value.trim();

  if (!w || !p || !j) {
    dictStatusEl.textContent = "すべて入力してください。";
    return;
  }

  // 保存
  USER_DICT[w] = { pinyin: p, ja: j };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(USER_DICT));

  // 有効辞書にも反映
  CUSTOM_DICT[w] = { pinyin: p, ja: j };

  dictStatusEl.textContent = `「${w}」を登録しました。`;
  dictWordEl.value = "";
  dictPinyinEl.value = "";
  dictJaEl.value = "";

  // 表示中の文を更新
  if (sentences.length > 0) show(index);
};

/* ---- UI 操作 ---- */
pasteBtn.onclick = async () => {
  try {
    sourceInput.value = await navigator.clipboard.readText();
  } catch {
    alert("クリップボードを読み込めません。");
  }
};

clearBtn.onclick = () => {
  sourceInput.value = "";
  viewer.style.display = "none";
};

translateBtn.onclick = () => {
  sentences = splitSentences(sourceInput.value);
  if (sentences.length === 0) {
    alert("文章がありません");
    return;
  }
  viewer.style.display = "block";
  show(0);
};

prevBtn.onclick = () => {
  if (!loading && index > 0) show(index - 1);
};
nextBtn.onclick = () => {
  if (!loading && index < sentences.length - 1) show(index + 1);
};
</script>
</body>
</html>
