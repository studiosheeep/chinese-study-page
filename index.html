<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>中国語 一文ずつビュー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      background: #f3f4f6;
      color: #111827;
    }

    .app {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 16px;
    }

    .app-inner {
      width: 100%;
      max-width: 960px;
    }

    h1 {
      font-size: 20px;
      margin: 0 0 12px;
      text-align: left;
    }

    textarea {
      width: 100%;
      min-height: 120px;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      resize: vertical;
      background: #ffffff;
    }

    button {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      cursor: pointer;
    }

    button:hover { background: #f3f4f6; }
    button:disabled { opacity: 0.5; cursor: default; }

    .button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0 12px;
    }

    .button-row button { min-width: 80px; }

    .sentence-box {
      padding: 12px;
      border-radius: 8px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 6px rgba(15, 23, 42, 0.06);
      margin-top: 4px;
    }

    .label {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 2px;
    }

    .chinese {
      font-size: 20px;
      margin-bottom: 4px;
      word-wrap: break-word;
    }

    .pinyin {
      font-size: 14px;
      color: #374151;
      margin-bottom: 4px;
      word-wrap: break-word;
    }

    .jp {
      font-size: 14px;
      margin-bottom: 4px;
      word-wrap: break-word;
    }

    .nav-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
      font-size: 12px;
      color: #6b7280;
    }

    .nav-row-left {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .word-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    .word-card {
      border: 1px solid #e5e7eb;
      padding: 4px 6px;
      border-radius: 6px;
      font-size: 12px;
      min-width: 80px;
      background: #ffffff;
    }

    .word-card .hanzi { font-size: 14px; margin-bottom: 2px; }
    .word-card .pinyin { color: #374151; margin-bottom: 2px; }
    .word-card .mean { color: #4b5563; }

    /* 単語登録フォーム */
    .dict-form {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }
    .dict-form input {
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      font-size: 12px;
    }
    .dict-form input.dict-word   { width: 120px; }
    .dict-form input.dict-pinyin { width: 160px; }
    .dict-form input.dict-ja     { flex: 1 1 160px; }

    #dictStatus {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }

    @media (max-width: 480px) {
      .app { padding: 8px; }
      .app-inner { max-width: 100%; }

      h1 {
        font-size: 18px;
        text-align: center;
        margin-bottom: 10px;
      }

      textarea {
        font-size: 13px;
        min-height: 100px;
      }

      button {
        font-size: 12px;
        padding: 6px 8px;
      }

      .sentence-box { padding: 10px; }
      .chinese { font-size: 18px; }
      .pinyin, .jp { font-size: 13px; }

      .word-cards { gap: 6px; }

      .word-card {
        flex: 1 1 calc(50% - 6px);
        min-width: 0;
      }

      .dict-form {
        flex-direction: column;
        align-items: stretch;
      }
      .dict-form input.dict-word,
      .dict-form input.dict-pinyin,
      .dict-form input.dict-ja {
        width: 100%;
      }
      .dict-form button {
        align-self: flex-start;
      }
    }
  </style>

  <!-- pinyin-pro -->
  <script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.27.0/dist/index.min.js"></script>

  <!-- segmentit UMD -->
  <script src="https://cdn.jsdelivr.net/npm/segmentit@2.0.3/dist/umd/segmentit.min.js"></script>
</head>

<body>
  <div class="app">
    <div class="app-inner">
      <h1>中国語 一文ずつビュー</h1>

      <textarea id="sourceInput" placeholder="ここに中国語を貼り付けてください"></textarea>

      <div class="button-row">
        <button id="pasteBtn">ペースト</button>
        <button id="clearBtn">全消し</button>
        <button id="translateBtn" style="background:#22c55e; color:white; border-color:#16a34a;">翻訳する</button>
      </div>

      <div id="viewer" class="sentence-box" style="display:none;">
        <div class="label">中国語</div>
        <div id="cnSentence" class="chinese"></div>

        <div class="label">ピンイン</div>
        <div id="pinyinSentence" class="pinyin"></div>

        <div class="label">日本語訳</div>
        <div id="jpSentence" class="jp"></div>

        <div class="nav-row">
          <div class="nav-row-left">
            <button id="prevBtn">◀</button>
            <button id="nextBtn">▶</button>
          </div>
          <span id="counter"></span>
          <span id="status"></span>
        </div>

        <div class="label" style="margin-top:10px;">単語カード</div>
        <div id="wordCards" class="word-cards"></div>

        <div class="label" style="margin-top:10px;">単語登録</div>
        <div class="dict-form">
          <input id="dictWord"   class="dict-word"   placeholder="漢字 例: 萨菲罗斯">
          <input id="dictPinyin" class="dict-pinyin" placeholder="ピンイン 例: sà fēi luó sī">
          <input id="dictJa"     class="dict-ja"     placeholder="日本語訳 例: セフィロス">
          <button id="dictAddBtn">登録</button>
        </div>
        <div id="dictStatus"></div>

        <div id="segStatus" class="label" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

<script>
  const STORAGE_KEY = "customCnDict";

  // ベース辞書（コード埋め込み分）
  const BASE_DICT = {
    "克劳德": { pinyin: "kè láo dé", ja: "クラウド" },
    "萨菲罗斯": { pinyin: "sà fēi luó sī", ja: "セフィロス" },
    "宝条": { pinyin: "bǎo tiáo", ja: "宝条" },
    "艾瑞丝": { pinyin: "ài ruì sī", ja: "エアリス" },
    "蒂法": { pinyin: "dì fǎ", ja: "ティファ" }
  };

  function loadUserDict() {
    try {
      const data = localStorage.getItem(STORAGE_KEY);
      return data ? JSON.parse(data) : {};
    } catch {
      return {};
    }
  }

  let USER_DICT = loadUserDict();

  // 実際に使う辞書（ベース＋ユーザー辞書）
  const CUSTOM_DICT = { ...BASE_DICT, ...USER_DICT };

  const hasPinyinPro = !!(window.pinyinPro && typeof window.pinyinPro.pinyin === "function");

  // segmentit 初期化
  let segmenter = null;
  if (window.Segmentit && window.Segmentit.Segment && typeof window.Segmentit.useDefault === "function") {
    segmenter = window.Segmentit.useDefault(new window.Segmentit.Segment());
  }

  const sourceInput   = document.getElementById("sourceInput");
  const pasteBtn      = document.getElementById("pasteBtn");
  const clearBtn      = document.getElementById("clearBtn");
  const translateBtn  = document.getElementById("translateBtn");

  const viewer        = document.getElementById("viewer");
  const cnSentenceEl  = document.getElementById("cnSentence");
  const pinyinSentenceEl = document.getElementById("pinyinSentence");
  const jpSentenceEl  = document.getElementById("jpSentence");
  const wordCardsEl   = document.getElementById("wordCards");
  const statusEl      = document.getElementById("status");
  const segStatusEl   = document.getElementById("segStatus");

  const prevBtn       = document.getElementById("prevBtn");
  const nextBtn       = document.getElementById("nextBtn");
  const counterEl     = document.getElementById("counter");

  const dictWordEl    = document.getElementById("dictWord");
  const dictPinyinEl  = document.getElementById("dictPinyin");
  const dictJaEl      = document.getElementById("dictJa");
  const dictAddBtn    = document.getElementById("dictAddBtn");
  const dictStatusEl  = document.getElementById("dictStatus");

  let sentences = [];
  let index = 0;
  let loading = false;

  segStatusEl.textContent = segmenter
    ? "単語分割: segmentit を使用中（単語ごとにカードを生成）"
    : "単語分割: segmentit が読み込めていないため漢字1文字ごと";

  function splitSentences(text) {
    if (!text) return [];
    return text
      .replace(/\r\n/g, "\n")
      .replace(/\s+/g, "")
      .split(/(?<=[。！？!?])/)
      .map(s => s.trim())
      .filter(Boolean);
  }

  async function translate(text) {
    const url =
      "https://translate.googleapis.com/translate_a/single?client=gtx&sl=zh&tl=ja&dt=t&q=" +
      encodeURIComponent(text);
    const res = await fetch(url);
    const data = await res.json();
    return data[0].map(x => x[0]).join("");
  }

  function hasCJK(str) {
    return /[\u3400-\u9FFF]/.test(str);
  }

  // 名前範囲でトークンをマージ
  function mergeNamesByRange(text, tokens, positions) {
    const ranges = [];
    const names = Object.keys(CUSTOM_DICT);

    for (const name of names) {
      let idx = text.indexOf(name);
      while (idx !== -1) {
        ranges.push({ name, start: idx, end: idx + name.length });
        idx = text.indexOf(name, idx + 1);
      }
    }

    if (!ranges.length) return { tokens, positions };

    ranges.sort((a, b) => a.start - b.start);

    const mergedTokens = [];
    const mergedPositions = [];

    let rangeIndex = 0;
    let currentRange = ranges[rangeIndex];

    for (let i = 0; i < tokens.length; i++) {
      const pos = positions[i];

      while (currentRange && pos.start >= currentRange.end) {
        currentRange = ranges[++rangeIndex];
      }

      if (
        currentRange &&
        pos.start >= currentRange.start &&
        pos.end   <= currentRange.end
      ) {
        if (
          !mergedTokens.length ||
          mergedTokens[mergedTokens.length - 1] !== currentRange.name
        ) {
          mergedTokens.push(currentRange.name);
          mergedPositions.push({
            start: currentRange.start,
            end: currentRange.end
          });
        }

        while (
          i + 1 < tokens.length &&
          positions[i + 1].end <= currentRange.end
        ) {
          i++;
        }
      } else {
        mergedTokens.push(tokens[i]);
        mergedPositions.push(pos);
      }
    }

    return { tokens: mergedTokens, positions: mergedPositions };
  }

  // 単語カード生成
  async function buildWordCards(sentence) {
    let words = [];

    if (segmenter) {
      const segObjs = segmenter.doSegment(sentence);
      const rawTokens = [];
      const rawPositions = [];
      let cursor = 0;

      for (const s of segObjs) {
        const w = s.w || "";
        if (!w) continue;

        const idx = sentence.indexOf(w, cursor);
        if (idx === -1) continue;

        const start = idx;
        const end   = idx + w.length;
        cursor = end;

        if (/^\s+$/.test(w)) continue;

        rawTokens.push(w);
        rawPositions.push({ start, end });
      }

      const merged = mergeNamesByRange(sentence, rawTokens, rawPositions);
      const tokens = merged.tokens;

      words = [...new Set(tokens.filter(hasCJK))];
    } else {
      const blocks = sentence.match(/[\u4e00-\u9fff]+/g) || [];
      const set = new Set();
      blocks.forEach(b => { for (const ch of b) set.add(ch); });
      words = [...set];
    }

    const cards = [];
    for (let w of words) {
      let py, jp;

      if (CUSTOM_DICT[w]) {
        py = CUSTOM_DICT[w].pinyin;
        jp = CUSTOM_DICT[w].ja;
      } else {
        py = hasPinyinPro
          ? window.pinyinPro.pinyin(w, { toneType:"pinyin", type:"string" })
          : "-";
        try {
          jp = await translate(w);
        } catch (e) {
          jp = "(翻訳エラー)";
        }
      }

      cards.push({ w, pinyin: py, jp });
    }
    return cards;
  }

  async function show(idx) {
    index = idx;
    const s = sentences[index];

    cnSentenceEl.textContent = s;
    pinyinSentenceEl.textContent = "";
    jpSentenceEl.textContent = "";
    counterEl.textContent = `${index + 1} / ${sentences.length}`;
    wordCardsEl.innerHTML = "";

    loading = true;
    statusEl.textContent = "読み込み中…";

    try {
      const py = hasPinyinPro
        ? window.pinyinPro.pinyin(s, {
            toneType: "pinyin",
            type: "string",
            nonZh: "consecutive"
          })
        : "(pinyin-pro が読み込めていません)";
      const jp = await translate(s);
      const cards = await buildWordCards(s);

      pinyinSentenceEl.textContent = py;
      jpSentenceEl.textContent = jp;

      cards.forEach(c => {
        wordCardsEl.innerHTML += `
          <div class="word-card">
            <div class="hanzi">${c.w}</div>
            <div class="pinyin">${c.pinyin}</div>
            <div class="mean">${c.jp}</div>
          </div>`;
      });
    } catch (e) {
      jpSentenceEl.textContent = "エラー：" + e.message;
    } finally {
      statusEl.textContent = "";
      loading = false;
    }
  }

  // 単語登録フォーム処理
  dictAddBtn.onclick = () => {
    const w = dictWordEl.value.trim();
    const p = dictPinyinEl.value.trim();
    const j = dictJaEl.value.trim();

    if (!w || !p || !j) {
      dictStatusEl.textContent = "漢字・ピンイン・日本語訳をすべて入力してください。";
      return;
    }

    // USER_DICT と CUSTOM_DICT に反映
    USER_DICT[w] = { pinyin: p, ja: j };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(USER_DICT));

    CUSTOM_DICT[w] = { pinyin: p, ja: j };

    dictStatusEl.textContent = `「${w}」を登録しました。`;
    dictWordEl.value = "";
    dictPinyinEl.value = "";
    dictJaEl.value = "";

    // 今表示中の文を再描画してカードに反映
    if (sentences.length > 0) {
      show(index);
    }
  };

  pasteBtn.onclick = async () => {
    try {
      const text = await navigator.clipboard.readText();
      if (!text) {
        alert("クリップボードにテキストがありません。");
        return;
      }
      sourceInput.value = text;
    } catch (e) {
      alert("クリップボードから読み取れませんでした：" + e.message);
    }
  };

  clearBtn.onclick = () => {
    sourceInput.value = "";
    viewer.style.display = "none";
  };

  translateBtn.onclick = () => {
    sentences = splitSentences(sourceInput.value);
    if (sentences.length === 0) {
      alert("文章がありません");
      return;
    }
    viewer.style.display = "block";
    show(0);
  };

  prevBtn.onclick = () => {
    if (!loading && index > 0) show(index - 1);
  };

  nextBtn.onclick = () => {
    if (!loading && index < sentences.length - 1) show(index + 1);
  };
</script>
</body>
</html>
